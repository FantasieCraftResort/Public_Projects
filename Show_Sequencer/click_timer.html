
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Key Press Timer</title>
    <style>
      body {
        font-family: monospace;
        background: #111;
        color: #0f0;
        padding: 20px;
      }
      input, button, select {
        margin: 5px;
      }
      #output {
        margin-top: 20px;
        white-space: pre;
      }
      #keyInput {
        width: 150px;
        text-align: center;
      }
      .timers {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #0f0;
        border-radius: 5px;
        width: fit-content;
      }
      .row { margin: 6px 0; }
      .inline { display: inline-block; margin-right: 10px; }
    </style>
  </head>
  <body>
    <h1>Key Press Timer</h1>

    <label for="keyInput">Press key to track: </label>
    <input type="text" id="keyInput" placeholder="Press any key" readonly />
    <br />

    <label for="stopTime">Stop after (seconds): </label>
    <input type="number" id="stopTime" value="10" step="0.1" />
    <br />

    <label for="maxDelta">Stop if delta t &gt; (seconds): </label>
    <input type="number" id="maxDelta" value="2" step="0.1" />
    <br />

    <div class="row">
      <div class="inline">
        <label for="timeMode">Display mode: </label>
        <select id="timeMode">
          <option value="delta">Δt (between presses)</option>
          <option value="absolute">t (since start)</option>
        </select>
      </div>

      <!-- NEW: Units toggle button -->
      <div class="inline">
        <button id="unitToggle">Units: seconds</button>
      </div>
    </div>

    <button onclick="startTimer()">Start</button>
    <button onclick="resetTimer()">Reset</button>

    <div class="timers">
      <div>
        <span id="currentLabel">Current Δt</span>:
        <span id="currentDisplay">0.00</span> <span id="currentUnit">s</span>
      </div>
      <div>
        Total t: <span id="totalDisplay">0.00</span> <span id="totalUnit">s</span>
      </div>
    </div>

    <div id="output"></div>

    <script>
      let trackingKey = null;
      let startTime = null;
      let lastTime = null;
      let stopAfter = 10;
      let maxDelta = 2;
      let running = false;
      let finished = false;
      let selectingKey = false;

      // Modes
      let timeMode = 'delta';        // 'delta' | 'absolute'
      let unitMode = 'seconds';      // 'seconds' | 'ticks' (1 tick = 1/20 s)

      const currentLabel = document.getElementById("currentLabel");
      const currentDisplay = document.getElementById("currentDisplay");
      const currentUnit = document.getElementById("currentUnit");
      const totalDisplay = document.getElementById("totalDisplay");
      const totalUnit = document.getElementById("totalUnit");
      const keyInput = document.getElementById("keyInput");
      const timeModeSelect = document.getElementById("timeMode");
      const unitToggleBtn = document.getElementById("unitToggle");

      // Helpers: convert and format values based on unitMode
      function toDisplay(valueSeconds) {
        // Convert raw seconds => display units
        if (unitMode === 'ticks') return valueSeconds * 20; // ticks
        return valueSeconds; // seconds
      }
      function formatDisplay(valueSeconds) {
        const v = toDisplay(valueSeconds);
        if (unitMode === 'ticks') {
          // ticks are natural counts → show integers
          return Math.round(v).toString();
        } else {
          // seconds → show 2 decimals
          return v.toFixed(2);
        }
      }
      function unitSuffix() {
        return unitMode === 'ticks' ? 'ticks' : 's';
      }

      // Toggle label when time mode changes
      timeModeSelect.addEventListener("change", () => {
        timeMode = timeModeSelect.value;
        currentLabel.textContent = timeMode === 'delta' ? "Current Δt" : "Current t";
      });

      // NEW: Units toggle button
      unitToggleBtn.addEventListener("click", () => {
        unitMode = unitMode === 'seconds' ? 'ticks' : 'seconds';
        unitToggleBtn.textContent = `Units: ${unitMode}`;
        currentUnit.textContent = unitSuffix();
        totalUnit.textContent = unitSuffix();
      });

      // Key selection handling
      keyInput.addEventListener("focus", () => {
        selectingKey = true;
      });
      keyInput.addEventListener("keydown", (e) => {
        e.preventDefault();
        trackingKey = e.key;
        keyInput.value = trackingKey === " " ? "Space" : trackingKey;
        keyInput.blur();
      });
      keyInput.addEventListener("blur", () => {
        selectingKey = false;
      });

      function startTimer() {
        if (!trackingKey) {
          alert("Please select a key first!");
          return;
        }
        if (finished) return;

        stopAfter = parseFloat(document.getElementById("stopTime").value);
        maxDelta = parseFloat(document.getElementById("maxDelta").value);
        startTime = performance.now();
        lastTime = startTime;
        running = true;
        finished = false;
        document.getElementById("output").textContent =
          `Tracking key "${trackingKey}"...\n`;
        updateLoop();
      }

      function resetTimer() {
        running = false;
        finished = false;
        document.getElementById("output").textContent = "";
        startTime = null;
        lastTime = null;
        currentDisplay.textContent = "0.00";
        totalDisplay.textContent = "0.00";
        // Keep units label consistent with current toggle
        currentUnit.textContent = unitSuffix();
        totalUnit.textContent = unitSuffix();
      }

      document.addEventListener("keydown", (e) => {
        // Ignore keys while selecting tracking key
        if (selectingKey) return;

        // Start on first press if not running and not finished
        if (!running && !finished && e.key === trackingKey) {
          startTimer();
          return;
        }

        // Handle presses while running
        if (running && e.key === trackingKey) {
          const now = performance.now();
          const deltaSec = (now - lastTime) / 1000;
          const absoluteSec = (now - startTime) / 1000;

          // Log depending on time mode, formatted by unit
          if (timeMode === 'delta') {
            document.getElementById("output").textContent +=
              `Δt=${formatDisplay(deltaSec)} ${unitSuffix()}\n`;
          } else {
            document.getElementById("output").textContent +=
              `t=${formatDisplay(absoluteSec)} ${unitSuffix()}\n`;
          }

          // Update last press time for Δt logic
          lastTime = now;

          // Stop condition (Δt in seconds; logic unaffected by display units)
          if (deltaSec > maxDelta) {
            document.getElementById("output").textContent +=
              `Stopped (delta exceeded ${maxDelta}s)\n`;
            running = false;
            finished = true;
          }
        }
      });

      function updateLoop() {
        if (!running) return;

        const now = performance.now();
        const totalSec = (now - startTime) / 1000;
        const deltaSec = (now - lastTime) / 1000;

        // Total always shown
        totalDisplay.textContent = formatDisplay(totalSec);
        totalUnit.textContent = unitSuffix();

        // Current shows Δt or absolute, per mode
        if (timeMode === 'delta') {
          currentDisplay.textContent = formatDisplay(deltaSec);
        } else {
          currentDisplay.textContent = formatDisplay(totalSec);
        }
        currentUnit.textContent = unitSuffix();

        // Stop checks (in seconds)
        if (totalSec >= stopAfter) {
          document.getElementById("output").textContent +=
            `Stopped (total time exceeded ${stopAfter}s)\n`;
          running = false;
          finished = true;
          return;
        }
        if (deltaSec > maxDelta) {
          document.getElementById("output").textContent +=
            `Stopped (delta exceeded ${maxDelta}s)\n`;
          running = false;
          finished = true;
          return;
        }

        requestAnimationFrame(updateLoop);
      }
    </script>
  </body>
</html>
